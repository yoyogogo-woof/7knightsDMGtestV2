<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>774傷害計算機</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
  
    /* 三欄結構（手機也維持三欄） */
    .three-col-grid {
      display: grid;
      grid-template-columns: 0.5fr 0.5fr 0.5fr;
      gap: 4px;
      align-items: center;
    }
    .row { display: contents; } /* 讓每個子元素自然落在三個欄 */

    /* 追加傷害展開子列：左文字 / 右輸入 */
    .adddmg-subrow {
      display: grid;
      grid-template-columns: 1fr 0.8fr;
      gap: 4px;
      align-items: center;
      margin-top: 4px;
    }
    .adddmg-subrow label {
      text-align: left;
      padding-left: 4px;
    }

    /* 讓外層容器在手機也置中且不貼邊 */
    .container-fixed {
      max-width: 50rem; /* ~max-w-5xl */
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      padding-left: .25rem;
      padding-right: .25rem;
    }
  </style>

</head>

<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col items-center py-8">

  <h1 class="text-3xl font-bold mb-6">774傷害計算機</h1>

  <div class="bg-white shadow-lg rounded-2xl p-4 w-full container-fixed space-y-4 text-[15px] leading-tight">

    <!-- 表頭 -->
    <div class="three-col-grid font-semibold text-gray-700">
      <div>欄位</div>
      <div class="text-center">裝備 A</div>
      <div class="text-center">裝備 B</div>
    </div>
    <hr class="border-gray-300">

    <!-- 主輸出 -->
    <div class="three-col-grid">
      <div class="row">
        <label class="text-sm">面板攻擊力</label>
        <div class="relative"><input id="A_atkPanel" type="number" class="border rounded p-1.5 w-full text-right"></div>
        <div class="relative"><input id="B_atkPanel" type="number" class="border rounded p-1.5 w-full text-right"></div>
      </div>
      <div class="row">
        <label class="text-sm">基礎攻擊力</label>
        <div class="relative"><input id="A_atkBase" type="number" class="border rounded p-1.5 w-full text-right"></div>
        <div class="relative"><input id="B_atkBase" type="number" class="border rounded p-1.5 w-full text-right"></div>
      </div>
      <div class="row">
        <label class="text-sm">招式倍率</label>
        <div class="relative">
          <input id="A_skillRate" type="number" class="border rounded p-1.5 w-full text-right pr-6">
          <span class="absolute right-2 top-1.5 text-gray-400">%</span>
        </div>
        <div class="relative">
          <input id="B_skillRate" type="number" class="border rounded p-1.5 w-full text-right pr-6">
          <span class="absolute right-2 top-1.5 text-gray-400">%</span>
        </div>
      </div>
      <div class="row">
        <label class="text-sm">暴擊傷害</label>
        <div class="relative">
          <input id="A_critDmg" type="number" class="border rounded p-1.5 w-full text-right pr-6">
          <span class="absolute right-2 top-1.5 text-gray-400">%</span>
        </div>
        <div class="relative">
          <input id="B_critDmg" type="number" class="border rounded p-1.5 w-full text-right pr-6">
          <span class="absolute right-2 top-1.5 text-gray-400">%</span>
        </div>
      </div>
      <div class="row">
        <label class="text-sm">陣型提升攻擊力</label>
        <div class="relative">
          <input id="A_formAtk" type="number" class="border rounded p-1.5 w-full text-right pr-6">
          <span class="absolute right-2 top-1.5 text-gray-400">%</span>
        </div>
        <div class="relative">
          <input id="B_formAtk" type="number" class="border rounded p-1.5 w-full text-right pr-6">
          <span class="absolute right-2 top-1.5 text-gray-400">%</span>
        </div>
      </div>
    </div>

    <!-- 分隔線（追加傷害上方） -->
    <hr class="border-gray-300">

    <!-- 追加傷害（在套裝效果上方） -->
    <div class="three-col-grid">
      <label class="text-sm">特殊技能</label>

      <!-- 裝備A -->
      <div>
        <select id="A_addDmgType" class="border rounded p-2 w-full">
          <option value="none">無追加傷害</option>
          <option value="espada">艾絲芭塔－神的審判</option>
	  <option value="kyle">凱爾－鎖鏈暴壓</option>
        </select>
	<div id="A_addDmgInputs_espada" class="hidden mt-2">
 	 <div class="adddmg-subrow">
 	   <label class="text-sm">是否強化此技能</label>
 	   <input id="A_espadaEnhanced" type="checkbox" class="scale-125">
 	 </div>
 	 <div class="adddmg-subrow">
 	   <label class="text-sm">是否強化被動技能</label>
 	   <input id="A_espadaEnhanced3" type="checkbox" class="scale-125">
 	 </div>
 	 <div class="adddmg-subrow">
 	   <label class="text-sm">是否已六突</label>
 	   <input id="A_espadaEnhanced2" type="checkbox" class="scale-125">
 	 </div>
 	 <div class="adddmg-subrow">
  	  <label class="text-sm">招式倍率</label>
	  <div class="relative">
  	  <input id="A_espadaSkillRate" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	  <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
 	 </div>
 	 <div class="adddmg-subrow">
  	  <label class="text-sm">四層被動傷害量增加</label>
	  <div class="relative">
  	  <input id="A_espadaDMGincrease" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	  <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
 	 </div>
 	 <div class="adddmg-subrow">
  	   <label class="text-sm">傷害為敵方生命力的</label>
	   <div class="relative">
   	   <input id="A_espadaHpPercent" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
  	 </div>
  	 <div class="adddmg-subrow">
  	   <label class="text-sm">傷害限制為攻擊力的</label>
	   <div class="relative">
  	   <input id="A_espadaDMGlimit" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
          </div>
 	 <div class="adddmg-subrow">
	   <label class="text-sm">敵方生命力</label>
 	   <input id="A_espadaEnemyHp" type="number" class="border rounded p-1.5 w-full text-right pr-6">
  	 </div>
        </div>
	<div id="A_addDmgInputs_kyle" class="hidden mt-2">
 	 <div class="adddmg-subrow">
  	  <label class="text-sm">是否強化此技能</label>
  	  <input id="A_kyleEnhanced" type="checkbox" class="scale-125">
 	 </div>
 	 <div class="adddmg-subrow">
 	   <label class="text-sm">招式倍率</label>
	   <div class="relative">
  	   <input id="A_kyleSkillRate" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
         </div>
 	 <div class="adddmg-subrow">
  	   <label class="text-sm">傷害為敵方生命力的</label>
	   <div class="relative">
   	   <input id="A_kyleHpPercent" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
  	 </div>
  	 <div class="adddmg-subrow">
  	   <label class="text-sm">傷害限制為攻擊力的</label>
	   <div class="relative">
  	   <input id="A_kyleDMGlimit" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
         </div>
  	 <div class="adddmg-subrow">
  	   <label class="text-sm">敵方已損失生命</label>
	   <div class="relative">
  	   <input id="A_kyleEnemyLoseHp" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
         </div>
 	 <div class="adddmg-subrow">
	   <label class="text-sm">敵方生命力</label>
 	   <input id="A_kyleEnemyHp" type="number" class="border rounded p-1.5 w-full text-right pr-6">
  	 </div>
        </div>
      </div>
      <!-- 裝備B -->
      <div>
        <select id="B_addDmgType" class="border rounded p-2 w-full">
          <option value="none">無追加傷害</option>
          <option value="espada">艾絲芭塔－神的審判</option>
	  <option value="kyle">凱爾－鎖鏈暴壓</option>
        </select>
	<div id="B_addDmgInputs_espada" class="hidden mt-2">
 	 <div class="adddmg-subrow">
 	   <label class="text-sm">是否強化此技能</label>
 	   <input id="B_espadaEnhanced" type="checkbox" class="scale-125">
 	 </div>
 	 <div class="adddmg-subrow">
 	   <label class="text-sm">是否強化被動技能</label>
 	   <input id="B_espadaEnhanced3" type="checkbox" class="scale-125">
 	 </div>
 	 <div class="adddmg-subrow">
 	   <label class="text-sm">是否已六突</label>
 	   <input id="B_espadaEnhanced2" type="checkbox" class="scale-125">
 	 </div>
 	 <div class="adddmg-subrow">
  	   <label class="text-sm">招式倍率</label>
	   <div class="relative">
  	   <input id="B_espadaSkillRate" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
 	 </div>
 	 <div class="adddmg-subrow">
  	  <label class="text-sm">四層被動傷害量增加</label>
	  <div class="relative">
  	  <input id="B_espadaDMGincrease" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	  <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
 	 </div>
 	 <div class="adddmg-subrow">
  	   <label class="text-sm">傷害為敵方生命力的</label>
	   <div class="relative">
   	   <input id="B_espadaHpPercent" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
  	 </div>
  	 <div class="adddmg-subrow">
  	   <label class="text-sm">傷害限制為攻擊力的</label>
	   <div class="relative">
  	   <input id="B_espadaDMGlimit" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
         </div>
 	 <div class="adddmg-subrow">
	   <label class="text-sm">敵方生命力</label>
 	   <input id="B_espadaEnemyHp" type="number" class="border rounded p-1.5 w-full text-right pr-6">
  	 </div>
        </div>
	<div id="B_addDmgInputs_kyle" class="hidden mt-2">
 	 <div class="adddmg-subrow">
  	  <label class="text-sm">是否強化此技能</label>
  	  <input id="B_kyleEnhanced" type="checkbox" class="scale-125">
 	 </div>
 	 <div class="adddmg-subrow">
 	   <label class="text-sm">招式倍率</label>
	   <div class="relative">
  	   <input id="B_kyleSkillRate" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
          </div>
 	 <div class="adddmg-subrow">
  	   <label class="text-sm">傷害為敵方生命力的</label>
	   <div class="relative">
   	   <input id="B_kyleHpPercent" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
  	 </div>
  	 <div class="adddmg-subrow">
  	   <label class="text-sm">傷害限制為攻擊力的</label>
	   <div class="relative">
  	   <input id="B_kyleDMGlimit" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
         </div>
  	 <div class="adddmg-subrow">
  	   <label class="text-sm">敵方已損失生命</label>
	   <div class="relative">
  	   <input id="B_kyleEnemyLoseHp" type="number" class="border rounded p-1.5 w-full text-right pr-6">
	   <span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
         </div>
 	 <div class="adddmg-subrow">
	   <label class="text-sm">敵方生命力</label>
 	   <input id="B_kyleEnemyHp" type="number" class="border rounded p-1.5 w-full text-right pr-6">
  	 </div>
        </div>
      </div>
  </div>

    <!-- 分隔線（套裝效果上方） -->
    <hr class="border-gray-300">

    <!-- 套裝效果 -->
    <div class="three-col-grid">
      <div class="row">
        <label class="text-sm">套裝效果</label>
        <div>
          <select id="A_setEffect" class="border rounded p-2 w-full">
            <option value="none">無套裝效果</option>
            <option value="tracker4">追蹤者四件套（弱點傷害 +35%）</option>
            <option value="assassin4">刺客四件套（無視防禦 +15%）</option>
            <option value="avenger2">復仇者兩件套（傷害量 +15%）</option>
            <option value="avenger4">復仇者四件套（傷害量 +30%）</option>
            <option value="avenger4Boss">復仇者四件套（BOSS 傷害量 +70%）</option>
          </select>
        </div>
        <div>
          <select id="B_setEffect" class="border rounded p-2 w-full">
            <option value="none">無套裝效果</option>
            <option value="tracker4">追蹤者四件套（弱點傷害 +35%）</option>
            <option value="assassin4">刺客四件套（無視防禦 +15%）</option>
            <option value="avenger2">復仇者兩件套（傷害量 +15%）</option>
            <option value="avenger4">復仇者四件套（傷害量 +30%）</option>
            <option value="avenger4Boss">復仇者四件套（BOSS 傷害量 +70%）</option>
          </select>
        </div>
      </div>
    </div>

    <!-- BUFF -->
    <hr class="border-gray-300">
    <p class="text-lg font-semibold">【BUFF（選填）】</p>
    <div class="three-col-grid">
      <div class="row">
        <label class="text-sm">攻擊力增加</label>
        <div class="relative"><input id="A_buffAtk" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_buffAtk" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
      </div>
      <div class="row">
        <label class="text-sm">弱點傷害量增加</label>
        <div class="relative"><input id="A_weakDmg" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_weakDmg" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
      </div>
      <div class="row">
        <label class="text-sm">傷害量增加</label>
        <div class="relative"><input id="A_revengeDmg" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_revengeDmg" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
      </div>
      <div class="row">
        <label class="text-sm">暴擊傷害增加</label>
        <div class="relative"><input id="A_buffCritDMG" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_buffCritDMG" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
      </div>
      <div class="row">
        <label class="text-sm">減少防禦力</label>
        <div class="relative"><input id="A_deffDown" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_deffDown" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
      </div>
      <div class="row">
        <label class="text-sm">無視防禦</label>
        <div class="relative"><input id="A_deffIgnore" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_deffIgnore" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
      </div>
      <div class="row">
        <label class="text-sm">物理/魔法脆弱</label>
        <div class="relative"><input id="A_enemyWeak" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_enemyWeak" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
      </div>
    </div>

    <!-- 寵物效果 -->
    <hr class="border-gray-300">
    <p class="text-lg font-semibold">【寵物效果】</p>
    <div class="three-col-grid">
      <div class="row">
        <label class="text-sm">寵物攻擊力</label>
        <div><input id="A_petAtkFlat" type="number" class="border rounded p-1.5 w-full text-right"></div>
        <div><input id="B_petAtkFlat" type="number" class="border rounded p-1.5 w-full text-right"></div>
      </div>
      <div class="row">
        <label class="text-sm">潛能：增加攻擊力</label>
        <div class="relative"><input id="A_petAtkPercent" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-1.5 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_petAtkPercent" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-1.5 top-1.5 text-gray-400">%</span></div>
      </div>
      <div class="row">
        <label class="text-sm">技能：增加攻擊力</label>
        <div class="relative"><input id="A_petSkillAtk" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-1.5 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_petSkillAtk" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-1.5 top-1.5 text-gray-400">%</span></div>
      </div>
      <div class="row">
        <label class="text-sm">技能：增加暴擊傷害</label>
        <div class="relative"><input id="A_petCritDmg" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-1.5 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_petCritDmg" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-1.5 top-1.5 text-gray-400">%</span></div>
      </div>
      <div class="row">
        <label class="text-sm">技能：增加傷害</label>
        <div class="relative"><input id="A_petDmgIncrese" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-1.5 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_petDmgIncrese" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-1.5 top-1.5 text-gray-400">%</span></div>
      </div>
    </div>

    <!-- 敵方防禦 -->
    <hr class="border-gray-300">
    <p class="text-lg font-semibold">【敵方防禦】</p>
    <div class="three-col-grid">
      <div class="row">
        <label class="text-sm">敵方防禦力</label>
        <div><input id="A_enemyDef" type="number" class="border rounded p-1.5 w-full text-right"></div>
        <div><input id="B_enemyDef" type="number" class="border rounded p-1.5 w-full text-right"></div>
      </div>
      <div class="row">
        <label class="text-sm">物理/魔法減傷</label>
        <div class="relative"><input id="A_reduceRate" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_reduceRate" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
      </div>
      <div class="row">
        <label class="text-sm">增加防禦力</label>
        <div class="relative"><input id="A_enemyDefIncrease" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
        <div class="relative"><input id="B_enemyDefIncrease" type="number" class="border rounded p-1.5 w-full text-right pr-6"><span class="absolute right-2 top-1.5 text-gray-400">%</span></div>
      </div>
    </div>

    <!-- 結果表 -->
    <hr class="border-gray-300">
    <div class="overflow-x-auto">
      <table class="w-full text-sm border border-gray-200">
        <thead>
          <tr class="bg-gray-50">
            <th class="p-2 border-b border-gray-200 text-left">類型</th>
            <th class="p-2 border-b border-gray-200 text-right">裝備 A</th>
            <th class="p-2 border-b border-gray-200 text-right">裝備 B</th>
          </tr>
        </thead>
        <tbody id="resultTable">
          <tr>
            <td class="p-2 border-b">無暴擊弱點</td>
            <td class="p-2 border-b text-right" id="A_nono">-</td>
            <td class="p-2 border-b text-right" id="B_nono">-</td>
          </tr>
          <tr>
            <td class="p-2 border-b">只觸發暴擊</td>
            <td class="p-2 border-b text-right" id="A_dmgCritOnly">-</td>
            <td class="p-2 border-b text-right" id="B_dmgCritOnly">-</td>
          </tr>
          <tr>
            <td class="p-2 border-b">只觸發弱點</td>
            <td class="p-2 border-b text-right" id="A_dmgWeakOnly">-</td>
            <td class="p-2 border-b text-right" id="B_dmgWeakOnly">-</td>
          </tr>
          <tr>
            <td class="p-2 border-b">暴擊＋弱點</td>
            <td class="p-2 border-b text-right text-blue-600 font-semibold" id="A_dmgBoth">-</td>
            <td class="p-2 border-b text-right text-blue-600 font-semibold" id="B_dmgBoth">-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 差異與操作 -->
    <div class="flex items-center justify-between">
      <div id="compareResult" class="text-base font-bold text-blue-600">請輸入完整數值</div>
      <button id="resetBtn" class="bg-red-500 text-white px-5 py-2 rounded-xl hover:bg-red-600 transition">重設所有數值</button>
    </div>
  </div>

<script>
  // === 工具函式 ===
  const $ = (id) => document.getElementById(id);
  const get = (p, f) => $(`${p}_${f}`);
  const saveLS = (p, f, val) => localStorage.setItem(`${p}_${f}`, val ?? '');
  const loadLS = (p, f) => localStorage.getItem(`${p}_${f}`);

  // === 欄位清單 ===
  const fieldList = [
    'atkPanel','atkBase','skillRate','critDmg','formAtk',
    'addDmgType','setEffect','buffAtk','weakDmg','revengeDmg','buffCritDMG',
    'deffDown','deffIgnore','petAtkFlat','petAtkPercent','petSkillAtk',
    'petCritDmg','petDmgIncrese','enemyDef','reduceRate','enemyDefIncrease','enemyWeak',
    'espadaEnhanced','espadaEnhanced2','espadaEnhanced3','espadaEnemyHp','espadaSkillRate','espadaHpPercent','espadaDMGlimit','espadaDMGincrease',
    'kyleEnhanced','kyleEnemyHp','kyleSkillRate','kyleHpPercent','kyleDMGlimit','kyleEnemyLoseHp'
  ];

  // === 載入所有 localStorage ===
  function loadAll() {
    ['A','B'].forEach(prefix => {
      fieldList.forEach(f => {
        const el = get(prefix, f);
        const val = loadLS(prefix, f);
        if (el && val !== null) {
          if (el.type === 'checkbox') el.checked = val === 'true';
          else el.value = val;
        }
      });
    });
    ['A','B'].forEach(toggleAddDmgVisibility);
  }

  // === 預設數值 ===========================

  // === 技能倍率 ===
  function setupSkillDefaults(prefix) {
    // 凱爾：倍率 50 → 強化後 65
    const kyleEnhanced = document.getElementById(prefix + '_kyleEnhanced');
    const kyleSkillRate = document.getElementById(prefix + '_kyleSkillRate');
    if (kyleEnhanced && kyleSkillRate) {
      kyleSkillRate.value = kyleEnhanced.checked ? 72 : 60;
    }
    const espadaEnhanced = document.getElementById(prefix + '_espadaEnhanced');
    const espadaSkillRate = document.getElementById(prefix + '_espadaSkillRate');
    if (espadaEnhanced && espadaSkillRate) {
      espadaSkillRate.value = espadaEnhanced.checked ? 515 : 425;
    }
  }

  // === 傷害為敵方生命力% ===
  function setupHpPercentDefaults(prefix) {
    // 凱爾：倍率 8 → 強化後 10
    const kyleEnhanced = document.getElementById(prefix + '_kyleEnhanced');
    const kyleHpPercent = document.getElementById(prefix + '_kyleHpPercent');
    if (kyleEnhanced && kyleHpPercent) {
      kyleHpPercent.value = kyleEnhanced.checked ? 10 : 8;
    }
    const espadaEnhanced2 = document.getElementById(prefix + '_espadaEnhanced2');
    const espadaHpPercent = document.getElementById(prefix + '_espadaHpPercent');
    if (espadaEnhanced2 && espadaHpPercent) {
      espadaHpPercent.value = espadaEnhanced2.checked ? 32 : 26;
    }
  }

  // === 傷害限制為攻擊力的% ===
  function setupDMGlimitDefaults(prefix) {
    // 凱爾：倍率 8 → 強化後 10
    const kyleEnhanced = document.getElementById(prefix + '_kyleEnhanced');
    const kyleDMGlimit = document.getElementById(prefix + '_kyleDMGlimit');
    if (kyleEnhanced && kyleDMGlimit) {
      kyleDMGlimit.value = kyleEnhanced.checked ? 75 : 75;
    }
    const espadaEnhanced2 = document.getElementById(prefix + '_espadaEnhanced2');
    const espadaDMGlimit = document.getElementById(prefix + '_espadaDMGlimit');
    const espadaDMGincrease = document.getElementById(prefix + '_espadaDMGincrease');
    if (espadaEnhanced2 && espadaDMGlimit) {
      espadaDMGlimit.value = espadaEnhanced2.checked ? 1600 : 1300;
      espadaDMGincrease.value = espadaEnhanced2.checked ? 40 : 32;
    }
  }

  // === 顯示/隱藏特殊技能區塊 ===
  function toggleAddDmgVisibility(prefix) {
    const sel = document.getElementById(prefix + '_addDmgType');
    const espada = document.getElementById(prefix + '_addDmgInputs_espada');
    const kyle = document.getElementById(prefix + '_addDmgInputs_kyle');
    if (!sel) return;

    if (espada) espada.classList.add('hidden');
    if (kyle) kyle.classList.add('hidden');

    if (sel.value === 'espada' && espada) espada.classList.remove('hidden');
    if (sel.value === 'kyle' && kyle) kyle.classList.remove('hidden');

    setupSkillDefaults(prefix);
    setupHpPercentDefaults(prefix);
    setupDMGlimitDefaults(prefix);
  }

  function refreshAddDmgUI() {
    ['A','B'].forEach(toggleAddDmgVisibility);
  }

  // === 同步欄位 ===
  function syncField(field) {
    // 不要自動同步的欄位（艾絲芭塔/凱爾的強化與其衍生欄位）
    const noSync = new Set([
      'espadaEnhanced','espadaEnhanced2','espadaEnhanced3',
      'kyleEnhanced',
      'espadaSkillRate','espadaHpPercent','espadaDMGlimit','espadaEnemyHp',
      'kyleSkillRate','kyleHpPercent','kyleDMGlimit','kyleEnemyHp'
    ]);
    if (noSync.has(field)) return;  // ← 直接跳過

    const a = get('A', field);
    const b = get('B', field);
    if (!a || !b) return;
    if (b.dataset.userEdited === 'true' && b.value !== '') return;

    if (a.type === 'checkbox') b.checked = a.checked;
    else b.value = a.value;

    b.dataset.autoSynced = 'true';
    b.classList.add('bg-gray-200','lock-icon');
    b.dataset.userEdited = 'false';
    saveLS('B', field, b.type === 'checkbox' ? b.checked : b.value);

    if (field === 'addDmgType') toggleAddDmgVisibility('B');
  }

  function syncAll() { fieldList.forEach(syncField); }

  // === 計算主函式 ===
  function calc(prefix) {
    const v = (f) => parseFloat(get(prefix,f)?.value) || 0;

    const atkPanel = v('atkPanel');
    const atkBase = v('atkBase');
    const formAtk = v('formAtk')/100;
    const skillRate = v('skillRate')/100;
    const critDmg = v('critDmg')/100;

    const buffAtk = v('buffAtk')/100;
    const weakDmg = (v('weakDmg')+30)/100;
    const revengeDmg = v('revengeDmg')/100;
    const buffCritDMG = v('buffCritDMG')/100;
    const deffDown = v('deffDown')/100;
    const deffIgnore = v('deffIgnore')/100;

    const petAtkFlat = v('petAtkFlat');
    const petSkillAtk = v('petSkillAtk')/100;
    const petCritDmg = v('petCritDmg')/100;
    const petAtkPercent = v('petAtkPercent')/100;
    const petDmgIncrese = v('petDmgIncrese')/100;

    const enemyDef = v('enemyDef');
    const reduceRate = v('reduceRate')/100;
    const enemyDefIncrease = v('enemyDefIncrease')/100;
    const enemyWeak = v('enemyWeak')/100;
    
    const setEffect = get(prefix,'setEffect')?.value || 'none';

    let weakDmgTotal = weakDmg;
    let revengeDmgTotal = revengeDmg;
    let deffIgnoreTotal = deffIgnore;

    switch (setEffect) {
      case 'tracker4': weakDmgTotal += 0.35; break;
      case 'avenger2': revengeDmgTotal += 0.15; break;
      case 'avenger4': revengeDmgTotal += 0.30; break;
      case 'avenger4Boss': revengeDmgTotal += 0.70; break;
      case 'assassin4': deffIgnoreTotal += 0.15; break;
    }

    const DEF_CONST = 467;
    const defCalc = enemyDef * (1 - deffDown + enemyDefIncrease) * (1 - deffIgnoreTotal);
    const rawDefRate = Math.trunc((defCalc / (DEF_CONST + defCalc)) * 10000) / 10000;
    const defRate = (1 - rawDefRate) * (1 - reduceRate + enemyWeak );
    const atkTotal = (atkPanel + atkBase * (formAtk + petAtkPercent) + petAtkFlat) * (1 + buffAtk + petSkillAtk);

    let dmgCritOnly, dmgWeakOnly, dmgBoth, nono;
    const addType = get(prefix, 'addDmgType')?.value;

    if (addType === 'espada') {
      const espadaEnemyHp = v('espadaEnemyHp');
      const espadaSkillRate = ((parseFloat( document.getElementById(prefix + '_espadaSkillRate').value ) || 0))/100;
      const espadaHpPercent = v('espadaHpPercent') / 100;
      const espadaDMGlimit = v('espadaDMGlimit') / 100;
      const espadaEnemyHPcalc = espadaEnemyHp * espadaHpPercent;
      const espadaMaxATK  = atkTotal * espadaDMGlimit;
      const espadaCompare = Math.min(espadaEnemyHPcalc, espadaMaxATK);
      const espd = document.getElementById(prefix + '_espadaEnhanced3').checked ? 0.4 : 0.32;
      const espadaDMGincrease = v('espadaDMGincrease') / 100;

      // 艾絲芭塔公式
      nono = ( atkTotal * espadaSkillRate * (1 + revengeDmgTotal + petDmgIncrese ) * defRate )
             + ( espadaCompare * (1 + revengeDmgTotal + espadaDMGincrease + petDmgIncrese ) * defRate );
      dmgCritOnly = ( atkTotal * espadaSkillRate * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + revengeDmgTotal + petDmgIncrese ) * defRate )
             + ( espadaCompare * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + revengeDmgTotal + espadaDMGincrease + petDmgIncrese) * defRate );
      dmgWeakOnly = ( atkTotal * espadaSkillRate * (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese ) * defRate )
             + ( espadaCompare * (1 + weakDmgTotal) * (1 + revengeDmgTotal + espadaDMGincrease + petDmgIncrese) * defRate );
      dmgBoth = ( atkTotal * espadaSkillRate * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese ) * defRate )
             + ( espadaCompare * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + weakDmgTotal) * (1 + revengeDmgTotal + espadaDMGincrease + petDmgIncrese) * defRate );
    }

      //凱爾公式
    else if (addType === 'kyle') {
      const kyleSkillRate = v('kyleSkillRate') / 100;
      const kyleEnemyLoseHp = Math.min(v('kyleEnemyLoseHp') / 100, 0.5);
      const kyleHpPercent = v('kyleHpPercent') / 100;
      const kyleDMGlimit = v('kyleDMGlimit') / 100;
      const kyleEnemyHp = v('kyleEnemyHp');
      const kyleMaxATK  = atkTotal * kyleDMGlimit;
      const kyleEnemyHPcalc = kyleEnemyHp * kyleHpPercent;
      const kyleCompare = Math.min(kyleEnemyHPcalc, kyleMaxATK);

      nono = ( atkTotal * ( kyleSkillRate + kyleEnemyLoseHp ) * (1 + revengeDmgTotal + petDmgIncrese) * defRate )
	    + ( kyleCompare * (1 + revengeDmgTotal + petDmgIncrese) * defRate ) ;
      dmgCritOnly = ( atkTotal * ( kyleSkillRate + kyleEnemyLoseHp ) * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + revengeDmgTotal + petDmgIncrese) * defRate )
	    + ( kyleCompare * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + revengeDmgTotal + petDmgIncrese) * defRate ) ;
      dmgWeakOnly = ( atkTotal * ( kyleSkillRate + kyleEnemyLoseHp ) * (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese) * defRate )
	    + ( kyleCompare * (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese) * defRate ) ;
      dmgBoth = ( atkTotal * ( kyleSkillRate + kyleEnemyLoseHp ) * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese) * defRate )
	    + ( kyleCompare * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese) * defRate ) ;
    }


    else {
      nono = atkTotal * skillRate * (1 + revengeDmgTotal + petDmgIncrese) * defRate;
      dmgCritOnly = atkTotal * skillRate * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + revengeDmgTotal + petDmgIncrese) * defRate;
      dmgWeakOnly = atkTotal * skillRate * (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese) * defRate;
      dmgBoth = atkTotal * skillRate * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese) * defRate;
    }

    return { nono, dmgCritOnly, dmgWeakOnly, dmgBoth };
  }

  // === 顯示結果 ===
  function showResults(prefix, data) {
    const fmt = (x) => !x || x<=0 ? '-' : Math.round(x).toLocaleString();
    $(`${prefix}_nono`).textContent        = fmt(data.nono);
    $(`${prefix}_dmgCritOnly`).textContent = fmt(data.dmgCritOnly);
    $(`${prefix}_dmgWeakOnly`).textContent = fmt(data.dmgWeakOnly);
    $(`${prefix}_dmgBoth`).textContent     = fmt(data.dmgBoth);
  }

  // === 顯示差異 ===
  function showDiff(a, b) {
    const box = $('compareResult');
    if (!a || !b || a<=0 || b<=0) { box.textContent = '請輸入完整數值'; return; }
    const diff = (b - a) / a * 100;
    const sign = diff >= 0 ? '多' : '少';
    const color = diff >= 0 ? 'text-green-600' : 'text-red-600';
    box.innerHTML = `B 比 A <span class="${color} font-bold">${sign}${Math.abs(diff).toFixed(2)}%</span>`;
  }

  // === 更新全部 ===
  function updateAll() {
    syncAll();
    const A = calc('A');
    const B = calc('B');
    showResults('A', A);
    showResults('B', B);
    showDiff(A.dmgBoth, B.dmgBoth);
    refreshAddDmgUI();
  }

  // === 輸入事件 ===
  function onInput(e) {
    const node = e.target;
    const [prefix, field] = node.id.split('_');
    saveLS(prefix, field, node.type === 'checkbox' ? node.checked : node.value);

    if (prefix === 'A') {
      syncField(field);
    } else if (prefix === 'B') {
      if (node.value !== '' || (node.type === 'checkbox' && node.checked)) {
        node.dataset.userEdited = 'true';
        node.classList.remove('bg-gray-200','lock-icon');
        delete node.dataset.autoSynced;
      } else {
        node.dataset.userEdited = 'false';
        syncField(field);
      }
    }

    if (field === 'addDmgType') toggleAddDmgVisibility(prefix);
    if (field === 'espadaEnhanced' || field === 'kyleEnhanced')
      setupSkillDefaults(prefix);

    updateAll();
  }

  function bindAll() {
    fieldList.forEach(f=>{
      const a = get('A',f), b = get('B',f);
      if (a) { a.addEventListener('input', onInput); a.addEventListener('change', onInput); }
      if (b) { b.addEventListener('input', onInput); b.addEventListener('change', onInput); }
    });
  }

  // === 重設 ===
  function resetAll() {
    if (!confirm('確定要清除所有數值嗎？')) return;
    fieldList.forEach(f=>{
      localStorage.removeItem(`A_${f}`);
      localStorage.removeItem(`B_${f}`);
      const a = get('A',f), b = get('B',f);
      if (a) { a.value = ''; if (a.type==='checkbox') a.checked=false; }
      if (b) { b.value = ''; if (b.type==='checkbox') b.checked=false; b.dataset.userEdited='false'; b.classList.remove('bg-gray-200','lock-icon'); }
    });
    ['A','B'].forEach(p=>{
      $(`${p}_nono`).textContent='-';
      $(`${p}_dmgCritOnly`).textContent='-';
      $(`${p}_dmgWeakOnly`).textContent='-';
      $(`${p}_dmgBoth`).textContent='-';
    });
    $('compareResult').textContent='請輸入完整數值';
    refreshAddDmgUI();
  }

  // === 初始化 ===
  loadAll();
  bindAll();
  syncAll();
  updateAll();
  $('resetBtn').addEventListener('click', resetAll);

  // === 離開前儲存 ===
  window.addEventListener('beforeunload', ()=>{
    fieldList.forEach(f=>{
      const a = get('A',f), b = get('B',f);
      if (a) saveLS('A',f,a.type==='checkbox'?a.checked:a.value);
      if (b) saveLS('B',f,b.type==='checkbox'?b.checked:b.value);
    });
  });
</script>


</body>
</html>



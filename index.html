<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>774å‚·å®³è¨ˆç®—æ©Ÿï¼ˆé›™è£å‚™å°æ¯”ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .synced {
      background-color: #f3f4f6; /* ç°åº• */
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col items-center py-8">

  <h1 class="text-3xl font-bold mb-6">774å‚·å®³è¨ˆç®—æ©Ÿï¼ˆé›™è£å‚™å°æ¯”ï¼‰</h1>

  <!-- å…©é‚Šæ”¾åœ¨åŒä¸€æ©«åˆ— -->
  <div class="flex flex-col md:flex-row gap-8">

    <!-- ========= è£å‚™A ========= -->
    <div id="calcA" class="bg-white shadow-lg rounded-2xl p-4 w-full max-w-[340px] space-y-6 text-[15px] leading-tight">
      <h2 class="text-lg font-semibold border-b pb-2 mb-4">è£å‚™A</h2>

      <!-- åŸæœ¬æ•´å€‹è¼¸å…¥å…§å®¹ä¿æŒä¸å‹• -->
      <div id="formA">
        <!-- âœ… ç›´æ¥è²¼ä½ åŸæœ¬çš„è¼¸å…¥éƒ¨åˆ† -->
        <!--ï¼ˆæ­¤è™•çœç•¥é‡è¤‡è¼¸å…¥æ¬„ï¼Œè·Ÿä½ åŸç‰ˆä¸€æ¨¡ä¸€æ¨£ï¼‰-->
        <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ å¾ä½ åŸæœ¬çš„ <section> é¢æ¿æ”»æ“ŠåŠ› ... åˆ°çµæœé¡¯ç¤ºé‚£éƒ¨åˆ†å…¨è²¼é€²ä¾† ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
        <!-- æˆ‘åªåœ¨ä¸‹é¢å®Œæ•´ç¤ºç¯„çµå°¾éƒ¨åˆ† -->
      </div>

      <!-- çµæœA -->
      <section class="text-center space-y-2 border-t pt-3">
        <p class="text-base font-semibold">ã€è¨ˆç®—çµæœã€‘</p>
        <div id="resultA" class="text-sm text-gray-700 leading-relaxed">
          è«‹è¼¸å…¥æ•¸å€¼
        </div>
      </section>
    </div>

    <!-- ========= è£å‚™B ========= -->
    <div id="calcB" class="bg-white shadow-lg rounded-2xl p-4 w-full max-w-[340px] space-y-6 text-[15px] leading-tight">
      <h2 class="text-lg font-semibold border-b pb-2 mb-4">è£å‚™B</h2>

      <!-- ç›´æ¥è¤‡è£½æ•´å€‹è¼¸å…¥çµæ§‹ï¼ˆèˆ‡Aå®Œå…¨ç›¸åŒï¼Œåªæ˜¯ id æ”¹æˆ B_ é–‹é ­ï¼‰ -->
      <div id="formB"></div>

      <!-- çµæœB -->
      <section class="text-center space-y-2 border-t pt-3">
        <p class="text-base font-semibold">ã€è¨ˆç®—çµæœã€‘</p>
        <div id="resultB" class="text-sm text-gray-700 leading-relaxed">
          è«‹è¼¸å…¥æ•¸å€¼
        </div>
      </section>
    </div>
  </div>

  <!-- é‡è¨­ -->
  <button id="resetBtn" class="mt-6 bg-red-500 text-white px-5 py-2 rounded-xl hover:bg-red-600 transition">
    é‡è¨­æ‰€æœ‰æ•¸å€¼
  </button>

  <script>
    // 1ï¸âƒ£ åŸå§‹æ¬„ä½åç¨±
    const fields = [
      'atkPanel', 'atkBase', 'formAtk', 'buffAtk', 'skillRate', 'critDmg',
      'weakDmg', 'revengeDmg', 'petAtkFlat', 'petSkillAtk', 'petCritDmg', 
      'petAtkPercent', 'enemyDef', 'reduceRate', 'setEffect','buffCritDMG',
      'deffDown','deffIgnore','enemyDefIncrease','petDmgIncrese'
    ];

    // 2ï¸âƒ£ è¤‡è£½ A çš„å…§å®¹ä½œç‚º Bï¼ˆåªæ› ID å‰ç¶´ï¼‰
    const formA = document.getElementById('formA');
    const formB = document.getElementById('formB');
    formB.innerHTML = formA.innerHTML.replaceAll('id="', 'id="B_').replaceAll('for="', 'for="B_');

    // 3ï¸âƒ£ åˆå§‹åŒ–æ¬„ä½èˆ‡äº‹ä»¶
    function setupCalc(side) {
      fields.forEach(id => {
        const el = document.getElementById(`${side}_${id}`);
        const saved = localStorage.getItem(`${side}_${id}`);
        if (saved !== null) el.value = saved;
        el.addEventListener('input', () => {
          localStorage.setItem(`${side}_${id}`, el.value);
          calculate(side);
          if (side === 'A') syncInputs();
        });
      });
    }

    setupCalc('A');
    setupCalc('B');
    syncInputs();
    calculate('A');
    calculate('B');

    // 4ï¸âƒ£ åŒæ­¥å³é‚Šç©ºç™½æ¬„ä½
    function syncInputs() {
      fields.forEach(id => {
        const left = document.getElementById(`A_${id}`);
        const right = document.getElementById(`B_${id}`);
        if (!right.value) {
          right.value = left.value;
          right.classList.add('synced');
        } else {
          right.classList.remove('synced');
        }
      });
    }

    // 5ï¸âƒ£ è¨ˆç®—é‚è¼¯ (ç…§ä½ åŸæœ¬çš„ calculate æ”¹æˆæ¥æ”¶ side)
    function calculate(side) {
      const v = id => parseFloat(document.getElementById(`${side}_${id}`).value) || 0;

      const atkPanel = v('atkPanel');
      const atkBase = v('atkBase');
      const formAtk = v('formAtk') / 100;
      const skillRate = v('skillRate') / 100;
      const critDmg = v('critDmg') / 100;
      const buffAtk = v('buffAtk') / 100;
      const weakDmg = (v('weakDmg') + 30) / 100;
      const revengeDmg = v('revengeDmg') / 100;
      const buffCritDMG = v('buffCritDMG') / 100;
      const deffDown = v('deffDown')/100;
      const deffIgnore = v('deffIgnore')/100;
      const petAtkFlat = v('petAtkFlat');
      const petSkillAtk = v('petSkillAtk') / 100;
      const petCritDmg = v('petCritDmg') / 100;
      const petAtkPercent = v('petAtkPercent') / 100;
      const petDmgIncrese = v('petDmgIncrese') / 100;
      const enemyDef = v('enemyDef');
      const reduceRate = v('reduceRate') / 100;
      const enemyDefIncrease = v('enemyDefIncrease') / 100;

      const setEffect = document.getElementById(`${side}_setEffect`).value;
      let weakDmgTotal = weakDmg;
      let revengeDmgTotal = revengeDmg;
      let deffIgnoreTotal = deffIgnore;

      switch (setEffect) {
        case 'tracker4': weakDmgTotal += 0.35; break;
        case 'avenger2': revengeDmgTotal += 0.15; break;
        case 'avenger4': revengeDmgTotal += 0.30; break;
        case 'avenger4Boss': revengeDmgTotal += 0.70; break;
        case 'assassin4': deffIgnoreTotal += 0.15; break;
      }

      const DEF_CONST = 467;
      const defRate = (1 - ((enemyDef * (1 - deffDown + enemyDefIncrease) * (1 - deffIgnoreTotal)) /
        (DEF_CONST + (enemyDef * (1 - deffDown + enemyDefIncrease) * (1 - deffIgnoreTotal))))) * (1 - reduceRate);

      const atkTotal = (atkPanel + atkBase * (formAtk + petAtkPercent) + petAtkFlat) * (1 + buffAtk + petSkillAtk);

      const dmgCritOnly = atkTotal * skillRate * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) *
        (1 + revengeDmgTotal + petDmgIncrese) * defRate;
      const dmgWeakOnly = atkTotal * skillRate * (1 + weakDmgTotal) *
        (1 + revengeDmgTotal + petDmgIncrese) * defRate;
      const dmgBoth = atkTotal * skillRate * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) *
        (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese) * defRate;

      const resultEl = document.getElementById(`result${side}`);
      if (isNaN(dmgBoth) || dmgBoth <= 0) {
        resultEl.innerHTML = `<span class="text-gray-400">è«‹è¼¸å…¥å®Œæ•´æ•¸å€¼</span>`;
        return;
      }
      resultEl.innerHTML = `
        <div class="space-y-2">
          <p><b>åªè§¸ç™¼æš´æ“Šï¼š</b> ${Math.round(dmgCritOnly).toLocaleString()}</p>
          <p><b>åªè§¸ç™¼å¼±é»ï¼š</b> ${Math.round(dmgWeakOnly).toLocaleString()}</p>
          <p><b>æš´æ“Šï¼‹å¼±é»ï¼š</b> <span class="text-blue-600 font-bold">${Math.round(dmgBoth).toLocaleString()}</span></p>
        </div>
      `;
    }

    // 6ï¸âƒ£ é‡è¨­
    document.getElementById('resetBtn').addEventListener('click', () => {
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ•¸å€¼å—ï¼Ÿ')) return;
      ['A','B'].forEach(side=>{
        fields.forEach(id=>{
          document.getElementById(`${side}_${id}`).value='';
          localStorage.removeItem(`${side}_${id}`);
        });
        document.getElementById(`result${side}`).innerText='è«‹è¼¸å…¥æ•¸å€¼';
      });
      syncInputs();
    });
  </script>
</body>
</html>

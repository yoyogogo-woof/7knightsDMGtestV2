<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>774傷害計算機（雙裝備對比）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .synced {
      background-color: #f3f4f6; /* 灰底 */
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col items-center py-8">
  <h1 class="text-3xl font-bold mb-6">774傷害計算機（雙裝備對比）</h1>

  <!-- 主容器 -->
  <div class="flex flex-col md:flex-row gap-6">

    <!-- ===== 左邊：裝備A ===== -->
    <div id="calcA" class="bg-white shadow-lg rounded-2xl p-4 w-full max-w-[340px] space-y-6 text-[15px] leading-tight">
      <h2 class="text-lg font-semibold border-b pb-2 mb-4 text-center">裝備A</h2>
      <div id="inputsA"></div>
      <section class="text-center space-y-2 border-t pt-3">
        <p class="text-base font-semibold">【計算結果】</p>
        <div id="resultA" class="text-sm text-gray-700 leading-relaxed">請輸入數值</div>
      </section>
    </div>

    <!-- ===== 右邊：裝備B ===== -->
    <div id="calcB" class="bg-white shadow-lg rounded-2xl p-4 w-full max-w-[340px] space-y-6 text-[15px] leading-tight">
      <h2 class="text-lg font-semibold border-b pb-2 mb-4 text-center">裝備B</h2>
      <div id="inputsB"></div>
      <section class="text-center space-y-2 border-t pt-3">
        <p class="text-base font-semibold">【計算結果】</p>
        <div id="resultB" class="text-sm text-gray-700 leading-relaxed">請輸入數值</div>
      </section>
    </div>

  </div>

  <button id="resetBtn" class="mt-6 bg-red-500 text-white px-5 py-2 rounded-xl hover:bg-red-600 transition">
    重設所有數值
  </button>

  <script>
    // ===== 原有欄位ID =====
    const fields = [
      'atkPanel', 'atkBase', 'formAtk', 'buffAtk', 'skillRate', 'critDmg',
      'weakDmg', 'revengeDmg', 'petAtkFlat', 'petSkillAtk', 'petCritDmg', 
      'petAtkPercent', 'enemyDef', 'reduceRate', 'setEffect','buffCritDMG',
      'deffDown','deffIgnore','enemyDefIncrease','petDmgIncrese'
    ];

    // ===== 動態產生輸入欄位區塊（直接複製你原本的HTML內容） =====
    const baseHTML = document.querySelector('body').innerHTML;
    const originalInputs = document.querySelector('div.bg-white').innerHTML;

    // 抽取原本主輸入區 HTML
    const sections = document.querySelectorAll('section:not(.text-center)');
    const inputHTML = Array.from(sections).map(s => s.outerHTML).join('');

    // 填入兩邊
    document.getElementById('inputsA').innerHTML = inputHTML.replaceAll('id="', 'id="A_');
    document.getElementById('inputsB').innerHTML = inputHTML.replaceAll('id="', 'id="B_');

    // ===== 初始化輸入與事件 =====
    function setupCalc(side) {
      fields.forEach(id => {
        const el = document.getElementById(`${side}_${id}`);
        el.addEventListener('input', () => {
          localStorage.setItem(`${side}_${id}`, el.value);
          calculate(side);
          if (side === 'A') syncInputs();
        });
        const saved = localStorage.getItem(`${side}_${id}`);
        if (saved !== null) el.value = saved;
      });
    }

    setupCalc('A');
    setupCalc('B');
    syncInputs();
    calculate('A');
    calculate('B');

    // ===== 同步右側欄位（當B沒填值時） =====
    function syncInputs() {
      fields.forEach(id => {
        const left = document.getElementById(`A_${id}`);
        const right = document.getElementById(`B_${id}`);
        if (!right.value) {
          right.value = left.value;
          right.classList.add('synced');
        } else {
          right.classList.remove('synced');
        }
      });
    }

    // ===== 計算邏輯（複製原有calculate並改成接收side） =====
    function calculate(side) {
      const v = id => parseFloat(document.getElementById(`${side}_${id}`).value) || 0;

      const atkPanel = v('atkPanel');
      const atkBase = v('atkBase');
      const formAtk = v('formAtk') / 100;
      const skillRate = v('skillRate') / 100;
      const critDmg = v('critDmg') / 100;
      const buffAtk = v('buffAtk') / 100;
      const weakDmg = (v('weakDmg') + 30) / 100;
      const revengeDmg = v('revengeDmg') / 100;
      const buffCritDMG = v('buffCritDMG') / 100;
      const deffDown = v('deffDown')/100;
      const deffIgnore = v('deffIgnore')/100;
      const petAtkFlat = v('petAtkFlat');
      const petSkillAtk = v('petSkillAtk') / 100;
      const petCritDmg = v('petCritDmg') / 100;
      const petAtkPercent = v('petAtkPercent') / 100;
      const petDmgIncrese = v('petDmgIncrese') / 100;
      const enemyDef = v('enemyDef');
      const reduceRate = v('reduceRate') / 100;
      const enemyDefIncrease = v('enemyDefIncrease') / 100;

      const setEffect = document.getElementById(`${side}_setEffect`).value;
      let weakDmgTotal = weakDmg;
      let revengeDmgTotal = revengeDmg;
      let deffIgnoreTotal = deffIgnore;

      switch (setEffect) {
        case 'tracker4': weakDmgTotal += 0.35; break;
        case 'avenger2': revengeDmgTotal += 0.15; break;
        case 'avenger4': revengeDmgTotal += 0.30; break;
        case 'avenger4Boss': revengeDmgTotal += 0.70; break;
        case 'assassin4': deffIgnoreTotal += 0.15; break;
      }

      const DEF_CONST = 467;
      const defRate = (1 - ((enemyDef * (1 - deffDown + enemyDefIncrease) * (1 - deffIgnoreTotal)) /
        (DEF_CONST + (enemyDef * (1 - deffDown + enemyDefIncrease) * (1 - deffIgnoreTotal))))) * (1 - reduceRate);

      const atkTotal = (atkPanel + atkBase * (formAtk + petAtkPercent) + petAtkFlat) * (1 + buffAtk + petSkillAtk);

      const dmgCritOnly = atkTotal * skillRate * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) *
        (1 + revengeDmgTotal + petDmgIncrese) * defRate;
      const dmgWeakOnly = atkTotal * skillRate * (1 + weakDmgTotal) *
        (1 + revengeDmgTotal + petDmgIncrese) * defRate;
      const dmgBoth = atkTotal * skillRate * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) *
        (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese) * defRate;

      const resultEl = document.getElementById(`result${side}`);
      if (isNaN(dmgBoth) || dmgBoth <= 0) {
        resultEl.innerHTML = `<span class="text-gray-400">請輸入完整數值</span>`;
        return;
      }
      resultEl.innerHTML = `
        <div class="space-y-2">
          <p><b>只觸發暴擊：</b> ${Math.round(dmgCritOnly).toLocaleString()}</p>
          <p><b>只觸發弱點：</b> ${Math.round(dmgWeakOnly).toLocaleString()}</p>
          <p><b>暴擊＋弱點：</b> <span class="text-blue-600 font-bold">${Math.round(dmgBoth).toLocaleString()}</span></p>
        </div>
      `;
    }

    // ===== 重設按鈕 =====
    document.getElementById('resetBtn').addEventListener('click', () => {
      if (!confirm('確定要清除所有數值嗎？')) return;
      ['A','B'].forEach(side=>{
        fields.forEach(id=>{
          document.getElementById(`${side}_${id}`).value='';
          localStorage.removeItem(`${side}_${id}`);
        });
        document.getElementById(`result${side}`).innerText='請輸入數值';
      });
    });
  </script>
</body>
</html>

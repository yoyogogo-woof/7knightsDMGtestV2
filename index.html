<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å‚·å®³è¨ˆç®—å™¨ï¼ˆå°é½Šä¿®æ­£ç‰ˆï¼‰</title>
<style>
  :root{
    --card-w:320px;
    --gap-x:18px;
    --input-h:34px;
    --input-w:140px;
    --diff-w:72px;
    --font: "Microsoft JhengHei", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{
    font-family:var(--font);
    background:#f5f6f8;
    margin:0;
    padding:28px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:18px;
  }
  h1{margin:0;font-size:20px}

  /* æ•´é«”ä¸‰æ¬„ grid (æ¯ä¸€åˆ—æœƒæ”¾ä¸‰å€‹ cell: å·¦ / ä¸­ / å³) */
  .grid-layout{
    display:grid;
    grid-template-columns: var(--card-w) var(--gap-x) var(--card-w);
    gap:0 var(--gap-x);
    align-items:start;
  }

  /* å·¦å³å¡ç‰‡å¤–æ¡†åªæ˜¯è¦–è¦ºæ•ˆæœï¼Œå¯¦éš›æ¬„ä½åˆ—æœƒå¡«å…¥åˆ° grid-row ä¸­ */
  .card {
    background:#fff;
    border-radius:12px;
    box-shadow:0 6px 18px rgba(15,23,42,0.06);
    padding:12px;
  }
  .card h2{margin:0 0 8px 0;font-size:15px}
  .section-title{font-weight:600;margin-top:12px;margin-bottom:8px;display:flex;align-items:center;gap:8px}

  /* æˆ‘å€‘æœƒåœ¨ grid ä¸­æ”¾ row cell */
  .row-cell {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    padding:6px 0;
  }
  .label{font-size:13px; white-space:nowrap; width:46%}
  .input-wrap{position:relative;width:54%}
  .input{
    width:100%;
    height:var(--input-h);
    border-radius:8px;
    border:1px solid #e2e8f0;
    text-align:right;
    padding:6px 10px;
    font-size:13px;
    background:#fff;
  }
  .input.gray{ background:#f3f4f6; }

  /* ç™¾åˆ†æ¯”å³å´ç¬¦è™Ÿ */
  .with-pct .input{ padding-right:34px; }
  .with-pct .pct {
    position:absolute;
    right:10px;
    top:50%;
    transform:translateY(-50%);
    color:#6b7280;
    font-size:13px;
    pointer-events:none;
  }

  /* ä¸­é–“ diff column */
  .diff-col{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    padding-top:6px;
  }
  .diff-input{
    width:var(--diff-w);
    height:var(--input-h);
    text-align:center;
    border-radius:8px;
    border:1px solid #e2e8f0;
    font-size:13px;
    color:#111827;
    background:#fff;
  }
  .diff-input::placeholder{color:#9ca3af}

  /* section headers (span across 3 columns) */
  .section-full {
    grid-column:1 / 4;
    display:flex;
    align-items:center;
    gap:8px;
    margin-top:10px;
  }

  /* results area */
  .results {
    width: calc(var(--card-w) * 2 + var(--gap-x));
    background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06);
  }

  /* make select wider and aligned */
  .select-wide{ width:100%; padding:6px; border-radius:8px; border:1px solid #e2e8f0; }

  /* smaller text */
  .small{ font-size:13px; color:#374151 }

  /* ensure labels align and input heights equal by using same row structure */
</style>
</head>
<body>

<h1>å‚·å®³è¨ˆç®—å™¨</h1>

<!-- grid-layout: left card column | gap | right card column -->
<div class="grid-layout" id="grid">

  <!-- We'll create the header area for left card (visual) -->
  <div class="card" id="leftCardVis">
    <h2>ğŸ—¡ ä¸»è¼¸å‡ºï¼ˆAï¼‰</h2>
    <!-- placeholder for spacing - content rows are created in grid rows below -->
  </div>

  <!-- middle column is intentionally empty top space to keep alignment -->
  <div></div>

  <div class="card" id="rightCardVis">
    <h2>ğŸ—¡ ä¸»è¼¸å‡ºï¼ˆBï¼‰</h2>
  </div>

  <!-- SECTION: main fields header across whole width -->
  <div class="section-full"><strong>ä¸»è¼¸å‡º</strong></div>

  <!-- Now we will render each field row as three sibling elements that occupy same grid row:
       left-cell (in first column), mid-cell (in second column), right-cell (in third column) -->
</div>

<!-- results -->
<div class="results" id="results">
  <div class="small"><strong>A çµæœï¼š</strong><span id="resA">è«‹è¼¸å…¥æ•¸å€¼</span></div>
  <div class="small" style="margin-top:6px;"><strong>B çµæœï¼š</strong><span id="resB">è«‹è¼¸å…¥æ•¸å€¼</span></div>
  <div style="margin-top:8px;"><strong id="resDiff">B vs A å·®ç•°ï¼š0%</strong></div>
</div>

<script>
/* Fields definition in display order */
const SECTIONS = [
  { title:'ä¸»è¼¸å‡º', fields:[
    {id:'atkPanel', label:'é¢æ¿æ”»æ“ŠåŠ›', type:'number'},
    {id:'atkBase', label:'åŸºç¤æ”»æ“ŠåŠ›', type:'number'},
    {id:'skillRate', label:'æ‹›å¼å€ç‡', type:'percent'},
    {id:'critDmg', label:'æš´æ“Šå‚·å®³', type:'percent'},
    {id:'formAtk', label:'é™£å‹æå‡æ”»æ“ŠåŠ›', type:'percent'},
  ]},
  { title:'å¥—è£æ•ˆæœ', fields:[
    // we'll have selects after the main fields area
  ]},
  { title:'BUFFï¼ˆé¸å¡«ï¼‰', fields:[
    {id:'buffAtk', label:'æ”»æ“ŠåŠ›å¢åŠ ', type:'percent'},
    {id:'weakDmg', label:'å¼±é»å‚·å®³é‡å¢åŠ ', type:'percent'},
    {id:'revengeDmg', label:'å‚·å®³é‡å¢åŠ ', type:'percent'},
    {id:'buffCritDMG', label:'æš´æ“Šå‚·å®³å¢åŠ ', type:'percent'},
    {id:'deffDown', label:'æ¸›å°‘é˜²ç¦¦åŠ›', type:'percent'},
    {id:'deffIgnore', label:'ç„¡è¦–é˜²ç¦¦', type:'percent'},
  ]},
  { title:'å¯µç‰©', fields:[
    {id:'petAtkFlat', label:'å¯µç‰©æ”»æ“ŠåŠ›', type:'number'},
    {id:'petAtkPercent', label:'æ½›èƒ½ï¼šå¢åŠ æ”»æ“ŠåŠ›', type:'percent'},
    {id:'petSkillAtk', label:'æŠ€èƒ½ï¼šå¢åŠ æ”»æ“ŠåŠ›', type:'percent'},
    {id:'petCritDmg', label:'æŠ€èƒ½ï¼šå¢åŠ æš´æ“Šå‚·å®³', type:'percent'},
    {id:'petDmgIncrese', label:'æŠ€èƒ½ï¼šå¢åŠ å‚·å®³', type:'percent'},
  ]},
  { title:'æ•µäºº', fields:[
    {id:'enemyDef', label:'æ•µæ–¹é˜²ç¦¦åŠ›', type:'number'},
    {id:'reduceRate', label:'ç‰©ç†/é­”æ³•æ¸›å‚·', type:'percent'},
    {id:'enemyDefIncrease', label:'å¢åŠ é˜²ç¦¦åŠ›', type:'percent'},
  ]}
];

/* build grid rows */
const grid = document.getElementById('grid');

function addSectionHeader(title){
  const header = document.createElement('div');
  header.className = 'section-full';
  header.textContent = title;
  grid.appendChild(header);
}

function addFieldRow(field){
  // left cell
  const leftCell = document.createElement('div');
  leftCell.className='row-cell';
  const lLabel = document.createElement('div'); lLabel.className='label'; lLabel.textContent = field.label;
  const lWrap = document.createElement('div'); lWrap.className='input-wrap';
  const lInput = document.createElement('input');
  lInput.type='number'; lInput.id = field.id + '-L'; lInput.className='input';
  if(field.type==='percent'){ lWrap.classList.add('with-pct'); const pct = document.createElement('div'); pct.className='pct'; pct.textContent='%'; lWrap.appendChild(pct); }
  lWrap.appendChild(lInput);
  leftCell.appendChild(lLabel); leftCell.appendChild(lWrap);

  // middle cell
  const midCell = document.createElement('div');
  midCell.style.display='flex'; midCell.style.justifyContent='center'; midCell.style.alignItems='center';
  const midInput = document.createElement('input'); midInput.className='diff-input'; midInput.id=field.id + '-D';
  midInput.placeholder = '+/-';
  if(field.type==='percent') {
    // add percent mark as pseudo by creating a small span absolute inside wrapper
    const wrapper = document.createElement('div'); wrapper.style.position='relative';
    midInput.style.paddingRight='20px';
    const mark = document.createElement('div'); mark.className='diff-percent-mark'; mark.textContent='%';
    mark.style.position='absolute'; mark.style.right='8px'; mark.style.top='50%'; mark.style.transform='translateY(-50%)'; mark.style.color='#6b7280';
    wrapper.appendChild(midInput); wrapper.appendChild(mark);
    midCell.appendChild(wrapper);
  } else {
    midCell.appendChild(midInput);
  }

  // right cell
  const rightCell = document.createElement('div');
  rightCell.className='row-cell';
  const rLabel = document.createElement('div'); rLabel.className='label'; rLabel.textContent = field.label;
  const rWrap = document.createElement('div'); rWrap.className='input-wrap';
  const rInput = document.createElement('input'); rInput.type='number'; rInput.id=field.id + '-R'; rInput.className='input gray';
  if(field.type==='percent'){ rWrap.classList.add('with-pct'); const pct2 = document.createElement('div'); pct2.className='pct'; pct2.textContent='%'; rWrap.appendChild(pct2); }
  rWrap.appendChild(rInput);
  rightCell.appendChild(rLabel); rightCell.appendChild(rWrap);

  grid.appendChild(leftCell);
  grid.appendChild(midCell);
  grid.appendChild(rightCell);
}

/* add main fields rows */
SECTIONS.forEach(section => {
  if(section.title!=='ä¸»è¼¸å‡º'){ addSectionHeader(section.title); }
  section.fields.forEach(f => addFieldRow(f));
});

/* add section for sets (in buff area) - we put selects in left and right columns, middle empty */
const setHeader = document.createElement('div'); setHeader.className='section-full'; setHeader.innerHTML = '<strong>å¥—è£æ•ˆæœï¼ˆæ”¾åœ¨ BUFF å€ä¸Šæ–¹ï¼‰</strong>'; grid.appendChild(setHeader);

// left select cell
const leftSetCell = document.createElement('div'); leftSetCell.style.display='flex'; leftSetCell.style.alignItems='center'; leftSetCell.style.gap='8px';
leftSetCell.style.padding='6px 0'; leftSetCell.innerHTML = '<div class="label">å¥—è£</div>';
const leftSelectWrap = document.createElement('div'); leftSelectWrap.style.width='54%';
const leftSelect = document.createElement('select'); leftSelect.id='set-L'; leftSelect.className='select-wide';
leftSelect.innerHTML = `
  <option value="none">ç„¡å¥—è£æ•ˆæœ</option>
  <option value="tracker4">è¿½è¹¤è€…å››ä»¶å¥— (+65% å¼±é»å‚·å®³)</option>
  <option value="avenger2">å¾©ä»‡è€…å…©ä»¶å¥— (+15% å‚·å®³é‡)</option>
  <option value="avenger4">å¾©ä»‡è€…å››ä»¶å¥— (+30% å‚·å®³é‡)</option>
  <option value="avenger4Boss">å¾©ä»‡è€…å››ä»¶å¥—(æ”»æ“Š BOSS) (+70% å‚·å®³é‡)</option>
`;
leftSelectWrap.appendChild(leftSelect); leftSetCell.appendChild(leftSelectWrap);
grid.appendChild(leftSetCell);

// middle empty
const emptyMid = document.createElement('div'); grid.appendChild(emptyMid);

// right select cell
const rightSetCell = document.createElement('div'); rightSetCell.style.display='flex'; rightSetCell.style.alignItems='center'; rightSetCell.style.gap='8px';
rightSetCell.style.padding='6px 0'; rightSetCell.innerHTML = '<div class="label">å¥—è£</div>';
const rightSelectWrap = document.createElement('div'); rightSelectWrap.style.width='54%';
const rightSelect = document.createElement('select'); rightSelect.id='set-R'; rightSelect.className='select-wide';
rightSelect.innerHTML = leftSelect.innerHTML;
rightSelectWrap.appendChild(rightSelect); rightSetCell.appendChild(rightSelectWrap);
grid.appendChild(rightSetCell);

/* append BUFF / PET / ENEMY headers and rows were added earlier via SECTIONS iteration */

/* --- Core sync logic --- */
function $(id){ return document.getElementById(id); }

const allFields = [];
SECTIONS.forEach(s => s.fields.forEach(f => allFields.push(f)));

allFields.forEach(f => {
  const L = $(f.id + '-L');
  const R = $(f.id + '-R');
  const D = $(f.id + '-D');

  // initial: R synced to L
  R.dataset.synced = 'true';
  R.classList.add('gray');

  // left input change -> if R synced and D empty, copy value
  L.addEventListener('input', () => {
    if((!D.value || D.value === '') && (R.dataset.synced === 'true' || R.value === '')) {
      R.value = L.value;
      R.dataset.synced = 'true';
      R.classList.add('gray');
    }
    recalcAll();
  });

  // diff change -> if empty: sync; else set R = L + diff & unsync
  D.addEventListener('input', () => {
    const base = parseFloat(L.value) || 0;
    const delta = parseFloat(D.value);
    if(!D.value || D.value === '' || isNaN(delta)) {
      R.value = L.value;
      R.dataset.synced = 'true';
      R.classList.add('gray');
    } else {
      R.value = base + delta;
      R.dataset.synced = 'false';
      R.classList.remove('gray');
    }
    recalcAll();
  });

  // right manual edit -> if same as left and D empty -> remain synced; else unsync
  R.addEventListener('input', () => {
    const lv = (L.value === '') ? '' : String(Number(L.value));
    const rv = (R.value === '') ? '' : String(Number(R.value));
    if(rv === '') {
      R.dataset.synced = 'true';
      R.value = L.value;
      R.classList.add('gray');
    } else if(rv === lv && (!D.value || D.value === '')) {
      R.dataset.synced = 'true';
      R.classList.add('gray');
    } else {
      R.dataset.synced = 'false';
      R.classList.remove('gray');
    }
    recalcAll();
  });
});

/* recalc function (use earlier formulas) */
function readSide(side){
  // side = 'L' or 'R'
  const vals = {};
  allFields.forEach(f => {
    const el = $(f.id + '-' + side);
    vals[f.id] = el && el.value !== '' ? parseFloat(el.value) : 0;
  });
  vals.set = $( 'set-' + side ).value;
  return vals;
}

function compute(vals){
  const atkPanel = vals.atkPanel || 0;
  const atkBase = vals.atkBase || 0;
  const formAtk = (vals.formAtk || 0)/100;
  const skillRate = (vals.skillRate || 0)/100;
  const critDmg = (vals.critDmg || 0)/100;
  const buffAtk = (vals.buffAtk || 0)/100;
  let weakDmg = (vals.weakDmg || 0)/100;
  let revenge = (vals.revengeDmg || 0)/100;
  let ignore = (vals.deffIgnore || 0)/100;
  const petAtkFlat = vals.petAtkFlat || 0;
  const petAtkPercent = (vals.petAtkPercent || 0)/100;
  const petSkillAtk = (vals.petSkillAtk || 0)/100;
  const petCrit = (vals.petCritDmg || 0)/100;
  const petDmgInc = (vals.petDmgIncrese || 0)/100;
  const buffCrit = (vals.buffCritDMG || 0)/100;
  const deffDown = (vals.deffDown || 0)/100;
  const enemyDef = vals.enemyDef || 0;
  const reduceRate = (vals.reduceRate || 0)/100;
  const enemyDefIncrease = (vals.enemyDefIncrease || 0)/100;

  // apply set
  switch(vals.set){
    case 'tracker4': weakDmg += 0.65; break;
    case 'avenger2': revenge += 0.15; break;
    case 'avenger4': revenge += 0.30; break;
    case 'avenger4Boss': revenge += 0.70; break;
    case 'assassin4': ignore += 0.15; break;
  }

  const DEF_CONST = 467;
  const adj = enemyDef * (1 - deffDown + enemyDefIncrease) * (1 - ignore);
  const defRate = (1 - (adj / (DEF_CONST + adj))) * (1 - reduceRate);

  const atkTotal = (atkPanel + atkBase * (formAtk + petAtkPercent) + petAtkFlat) * (1 + buffAtk + petSkillAtk);
  const baseDamage = atkTotal * skillRate;

  // crit multiplier: interpret user input as percent e.g. 200 => 2.00
  const critMultiplier = (critDmg + petCrit + buffCrit); // note: if input 200 -> 2.0
  const dmgCritOnly = baseDamage * critMultiplier * (1 + revenge + petDmgInc) * defRate;
  const dmgWeakOnly = baseDamage * (1 + weakDmg) * (1 + revenge + petDmgInc) * defRate;
  const dmgBoth = baseDamage * critMultiplier * (1 + weakDmg) * (1 + revenge + petDmgInc) * defRate;

  return {dmgCritOnly, dmgWeakOnly, dmgBoth};
}

function recalcAll(){
  const valsL = readSide('L'), valsR = readSide('R');
  const A = compute(valsL), B = compute(valsR);

  $('resA').textContent = `åªæš´æ“Šï¼š${Math.round(A.dmgCritOnly).toLocaleString()} ï½œ åªå¼±é»ï¼š${Math.round(A.dmgWeakOnly).toLocaleString()} ï½œ æœ€çµ‚ï¼š${Math.round(A.dmgBoth).toLocaleString()}`;
  $('resB').textContent = `åªæš´æ“Šï¼š${Math.round(B.dmgCritOnly).toLocaleString()} ï½œ åªå¼±é»ï¼š${Math.round(B.dmgWeakOnly).toLocaleString()} ï½œ æœ€çµ‚ï¼š${Math.round(B.dmgBoth).toLocaleString()}`;

  let pct = 0;
  if(A.dmgBoth > 0) pct = ((B.dmgBoth - A.dmgBoth) / A.dmgBoth) * 100;
  $('resDiff').textContent = `B vs A å·®ç•°ï¼š ${pct>=0?'+':''}${pct.toFixed(2)}%`;
}

/* attach change listeners for sets to recalc */
$('set-L').addEventListener('change', recalcAll);
$('set-R').addEventListener('change', recalcAll);

/* attach recalc to all inputs */
allFields.forEach(f => {
  const ids = [f.id+'-L', f.id+'-R', f.id+'-D'];
  ids.forEach(id => {
    const el = $(id);
    if(el) el.addEventListener('input', recalcAll);
  });
});

/* initial fill: copy left->right for all (so right shows gray synced) */
allFields.forEach(f => {
  const L = $(f.id+'-L'), R = $(f.id+'-R');
  if(L && R){
    R.value = L.value || '';
    R.dataset.synced = 'true';
    R.classList.add('gray');
  }
});

recalcAll();

</script>
</body>
</html>

<script>
  // 欄位清單
  const fieldList = [
    'atkPanel','atkBase','skillRate','critDmg','formAtk',
    'setEffect','buffAtk','weakDmg','revengeDmg','buffCritDMG',
    'deffDown','deffIgnore','petAtkFlat','petAtkPercent','petSkillAtk',
    'petCritDmg','petDmgIncrese','enemyDef','reduceRate','enemyDefIncrease'
  ];

  // 工具函式
  const $ = (id) => document.getElementById(id);
  const get = (p, f) => $(`${p}_${f}`);
  const saveLS = (p, f, val) => localStorage.setItem(`${p}_${f}`, val ?? '');
  const loadLS = (p, f) => localStorage.getItem(`${p}_${f}`);

  // 載入儲存值
  function loadAll() {
    ['A','B'].forEach(p=>{
      fieldList.forEach(f=>{
        const node = get(p,f);
        if (!node) return;
        const v = loadLS(p,f);
        if (v !== null) node.value = v;
      });
    });

    // 初始化 B 欄 userEdited 狀態
    fieldList.forEach(f=>{
      const b = get('B',f);
      if (!b) return;
      const v = b.value;
      if (v && v !== '') {
        b.dataset.userEdited = 'true';
        b.classList.remove('bg-gray-200','lock-icon');
      } else {
        b.dataset.userEdited = 'false';
      }
    });
  }

  // 計算函式
  function calc(prefix) {
    const v = (f) => parseFloat(get(prefix,f)?.value) || 0;

    const atkPanel = v('atkPanel');
    const atkBase = v('atkBase');
    const formAtk = v('formAtk')/100;
    const skillRate = v('skillRate')/100;
    const critDmg = v('critDmg')/100;

    const buffAtk = v('buffAtk')/100;
    const weakDmg = (v('weakDmg')+30)/100;
    const revengeDmg = v('revengeDmg')/100;
    const buffCritDMG = v('buffCritDMG')/100;
    const deffDown = v('deffDown')/100;
    const deffIgnore = v('deffIgnore')/100;

    const petAtkFlat = v('petAtkFlat');
    const petSkillAtk = v('petSkillAtk')/100;
    const petCritDmg = v('petCritDmg')/100;
    const petAtkPercent = v('petAtkPercent')/100;
    const petDmgIncrese = v('petDmgIncrese')/100;

    const enemyDef = v('enemyDef');
    const reduceRate = v('reduceRate')/100;
    const enemyDefIncrease = v('enemyDefIncrease')/100;

    const setEffect = get(prefix,'setEffect')?.value || 'none';

    let weakDmgTotal = weakDmg;
    let revengeDmgTotal = revengeDmg;
    let deffIgnoreTotal = deffIgnore;

    switch (setEffect) {
      case 'tracker4': weakDmgTotal += 0.35; break;
      case 'avenger2': revengeDmgTotal += 0.15; break;
      case 'avenger4': revengeDmgTotal += 0.30; break;
      case 'avenger4Boss': revengeDmgTotal += 0.70; break;
      case 'assassin4': deffIgnoreTotal += 0.15; break;
    }

    const DEF_CONST = 467;
    const defCalc = enemyDef * (1 - deffDown + enemyDefIncrease) * (1 - deffIgnoreTotal);
    const rawDefRate = (1 - (defCalc / (DEF_CONST + defCalc))) * (1 - reduceRate);
    const defRate = Math.trunc(rawDefRate * 10000) / 10000; // 無條件捨去4位

    const atkTotal = (atkPanel + atkBase * (formAtk + petAtkPercent) + petAtkFlat) * (1 + buffAtk + petSkillAtk);

    const dmgCritOnly = atkTotal * skillRate * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + revengeDmgTotal + petDmgIncrese) * defRate;
    const dmgWeakOnly = atkTotal * skillRate * (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese) * defRate;
    const dmgBoth = atkTotal * skillRate * (1 + (critDmg + petCritDmg + buffCritDMG - 1)) * (1 + weakDmgTotal) * (1 + revengeDmgTotal + petDmgIncrese) * defRate;
    const nono = atkTotal * skillRate * (1 + revengeDmgTotal + petDmgIncrese) * defRate;

    return { nono, dmgCritOnly, dmgWeakOnly, dmgBoth, defRate };
  }

  // 顯示結果到表格
  function showResults(prefix, data) {
    const fmt = (x) => !x || x<=0 ? '-' : Math.round(x).toLocaleString();
    $(`${prefix}_nono`).textContent = fmt(data.nono);
    $(`${prefix}_dmgCritOnly`).textContent = fmt(data.dmgCritOnly);
    $(`${prefix}_dmgWeakOnly`).textContent = fmt(data.dmgWeakOnly);
    $(`${prefix}_dmgBoth`).textContent = fmt(data.dmgBoth);
  }

  // 差異顯示
  function showDiff(a, b) {
    const box = $('compareResult');
    if (!a || !b || a<=0 || b<=0) { box.textContent = '請輸入完整數值'; return; }
    const diff = (b - a) / a * 100;
    const sign = diff >= 0 ? '多' : '少';
    const color = diff >= 0 ? 'text-green-600' : 'text-red-600';
    box.innerHTML = `B 比 A <span class="${color} font-bold">${sign}${Math.abs(diff).toFixed(2)}%</span>`;
  }

  // 同步（A -> B）僅空白或未被手動編輯過的欄位
  function syncField(field) {
    const a = get('A', field);
    const b = get('B', field);
    if (!a || !b) return;

    if (b.dataset.userEdited === 'true' && b.value !== '') return;

    b.value = a.value;
    b.dataset.autoSynced = 'true';
    b.classList.add('bg-gray-200','lock-icon');
    b.dataset.userEdited = 'false';
    saveLS('B', field, b.value);
  }

  function syncAll() {
    fieldList.forEach(syncField);
  }

  // 更新整體畫面
  function updateAll() {
    syncAll();

    const A = calc('A');
    const B = calc('B');
    showResults('A', A);
    showResults('B', B);
    showDiff(A.dmgBoth, B.dmgBoth);

    // 顯示雙方防禦倍率
    if (!$('defRateDisplay')) {
      const hr = document.querySelector('hr.border-gray-300:last-of-type');
      const div = document.createElement('div');
      div.id = 'defRateDisplay';
      div.className = 'text-sm text-gray-700 mt-2 ml-1 italic';
      div.innerHTML = `
        實際防禦倍率：
        <span id="defRateValueA" class="font-semibold text-blue-600">A: -</span>
        ｜ 
        <span id="defRateValueB" class="font-semibold text-green-600">B: -</span>
      `;
      hr.parentNode.insertBefore(div, hr);
    }

    $('defRateValueA').textContent = `A: ${A.defRate ? A.defRate.toFixed(4) : '-'}`;
    $('defRateValueB').textContent = `B: ${B.defRate ? B.defRate.toFixed(4) : '-'}`;
  }

  // 輸入事件處理
  function onInput(e) {
    const node = e.target;
    const id = node.id;
    const [prefix, field] = id.split('_');

    saveLS(prefix, field, node.value);

    if (prefix === 'A') {
      syncField(field);
    } else if (prefix === 'B') {
      if (node.value !== '') {
        node.dataset.userEdited = 'true';
        node.classList.remove('bg-gray-200','lock-icon');
        delete node.dataset.autoSynced;
      } else {
        node.dataset.userEdited = 'false';
        syncField(field);
      }
    }

    updateAll();
  }

  // 綁定所有 input/select
  function bindAll() {
    fieldList.forEach(f=>{
      const a = get('A',f), b = get('B',f);
      if (a) a.addEventListener('input', onInput);
      if (b) b.addEventListener('input', onInput);
    });
  }

  // 重設
  function resetAll() {
    if (!confirm('確定要清除所有數值嗎？')) return;
    fieldList.forEach(f=>{
      localStorage.removeItem(`A_${f}`);
      localStorage.removeItem(`B_${f}`);
      const a = get('A',f), b = get('B',f);
      if (a) a.value = '';
      if (b) {
        b.value = '';
        b.dataset.userEdited = 'false';
        b.classList.remove('bg-gray-200','lock-icon');
      }
    });
    ['A','B'].forEach(p=>{
      $(`${p}_nono`).textContent='-';
      $(`${p}_dmgCritOnly`).textContent='-';
      $(`${p}_dmgWeakOnly`).textContent='-';
      $(`${p}_dmgBoth`).textContent='-';
    });
    $('compareResult').textContent='請輸入完整數值';
    $('defRateValueA').textContent = 'A: -';
    $('defRateValueB').textContent = 'B: -';
  }

  // 初始化
  loadAll();
  bindAll();
  syncAll();
  updateAll();
  $('resetBtn').addEventListener('click', resetAll);

  window.addEventListener('beforeunload', ()=>{
    fieldList.forEach(f=>{
      const a = get('A',f), b = get('B',f);
      if (a) saveLS('A',f,a.value);
      if (b) saveLS('B',f,b.value);
    });
  });
</script>
